<?xml version="1.0" encoding="iso-8859-1"?> 

<project name="Integration-Smoke-Test" default="default" >
		<description>
        This ant script contains the integration smoke tests for CCTS installation
        </description>

	 <!-- PROPERTIES -->
	 <property environment="env" />
	 <property file="build.properties"/>
	 <property name="integration_smoke_test_home" value="." />
	 <property name="lib.dir" value="${integration_smoke_test_home}/lib"/>
	
	 <property name="log.dir" value="${integration_smoke_test_home}/logs" />
	 <property name="ext.globus.dir" value="${env.GLOBUS_LOCATION}" />
	
	<target name="default">
		<echo message="Please type -p to see available targerts"/>
	</target>


	<!--Get current timestamp for the log creation-->
	<tstamp>
		<format property="touch.time" pattern="yyyy-MM-dd-HH-mm" />
	</tstamp>

	<!--Initializes the logs-->
	<target name="init" >
		<mkdir dir="${log.dir}" />
		<record name="${log.dir}/CaXchange-Configuration-${touch.time}.log" action="start"/>
	</target>
	
	
	<!-- replaces the tokens with the property values -->
	<target name="replace"  >
		<replace dir="${integration_smoke_test_home}" includes="start_servicemix.sh,stop_servicemix.sh" propertyFile="${integration_smoke_test_home}/build.properties">
			<replacefilter token="@servicemix.home@" property="servicemix.home"/>
		</replace>
	</target>	


	<target name="detect-os-is-unix" >
    <condition property="isUnix">
	    <and>
		    <os family="unix"/>
		
	    </and>
    </condition>
	</target>
	   
    <target name="detect-os-is-win" >
    <condition property="isWin">
	    <and>
		    <os family="windows"/>
		 
	    </and>
    </condition>
	</target>

	<target name="detect-os-is-other" >
	 <condition property="isOtherOS">
             <not>
                 <or>
                     <os family="unix"/>
                     <os family="windows"/>
                 </or>
             </not>
         </condition>
		 </target>

	<target name="call-stop-servicemix-in-unix"  depends="detect-os-is-unix" if="isUnix">
		<chmod file="${integration_smoke_test_home}/stop_servicemix.sh" perm="744"/>
		 <exec dir="${integration_smoke_test_home}" executable="${integration_smoke_test_home}/stop_servicemix.sh" >
			 
		 <env key="PATH" path="${env.PATH}:${integration_smoke_test_home}"/>
		 </exec>
					
					
	</target>

	<target name="call-stop-servicemix-in-win"  depends="detect-os-is-win" if="isWin">
		 <echo message="Please stop servicemix."/>
	                <input   message="Is servicemix stopped?"
	                validargs="y,n"
	                addproperty="ifyessmokerestore1"/>
	                <condition property="ifnosmokerestore1">
	                <equals arg1="n" arg2="${ifyessmokerestore1}"/>
	                </condition>
	                <fail if="ifnosmokerestore1">Please stop servicemix and try again.</fail>
	</target>

	    
	<target name="set-default-caxchange-configuration" depends="replace,init" description="Restores caxchange routing configuration to default installation settings" >
	                <echo message="As part of this servicemix will be stopped and the current caXchange routing configuration will be overwritten."/>
	                <input   message="Do you want to continue?"
	                validargs="y,n"
	                addproperty="ifyessmokerestore"/>
	                <condition property="ifnosmokerestore">
	                <equals arg1="n" arg2="${ifyessmokerestore}"/>
	                </condition>
	                <fail if="ifnosmokerestore">To restore caxchange configuration please run this target again</fail>
					<antcall target="call-stop-servicemix-in-unix"/>
					<antcall target="call-stop-servicemix-in-win"/>
	                
			<copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
					<fileset dir="../${integration_smoke_test_home}/conf/caXchangeConf_restore"/>
	                </copy>
					<echo message="Please start servicemix.CaXchange routing configuration has been restored."/>
	</target>


	    <target name="configure-caxchange-not-to-invoke-target-services"   depends="replace,init"  description="Configures caxchange not to invoke target services" >
	                 
	    	       <condition property="ifNotInvoke">
	    		       <and>
	    		            <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
	    		        </and>
	    		</condition>
                       <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
                        <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/conf/caXchangeConf_original_before_testing."/>
	    		<echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
	                 <input   message="Do you want to continue?"
	                 validargs="y,n"
	                 addproperty="ifyesorginotinvoke"/>
	                 <condition property="ifnoorginotinvoke">
	                 <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
	                 </condition>
	                 <fail if="ifnoorginotinvoke">Please use this target to configure caXchange not to invoke target services </fail>
			 <antcall target="call-stop-servicemix-in-unix"/>
					<antcall target="call-stop-servicemix-in-win"/>
	                 <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
				<fileset dir="${servicemix.home}/conf/caXchangeConf"/>
			 </copy>
	    	         <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
	    					<fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_not_invoke_targetServices"/>
	    	         </copy>		
	    	 	<echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>
	    
	    
	    
	    
	    
	    <target name="configure-caxchange-to-invoke-only-labviewer"   depends="replace,init"  description="Configures caxchange to invoke only LabViewer target services for REGISTER_SUBJECT and STUDY_CREATION messages." >
		    
		    <condition property="ifNotInvoke">
			    <and>
				    <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
			    </and>
		    </condition>
		    <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
		    <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/conf/caXchangeConf_original_before_testing."/>
		    <echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
		    <input   message="Do you want to continue?"
			     validargs="y,n"
			     addproperty="ifyesorginotinvoke"/>
		    <condition property="ifnoorginotinvoke">
			    <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
		    </condition>
		    <fail if="ifnoorginotinvoke">Please use this target to configure caXchange to test integration only with LabViewer for STUDY_CREATION and REGISTER_SUBJECT messages </fail>
		    <antcall target="call-stop-servicemix-in-unix"/>
		    <antcall target="call-stop-servicemix-in-win"/>
		    <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
			    <fileset dir="${servicemix.home}/conf/caXchangeConf"/>
		    </copy>
		    <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
			    <fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_LabViewer"/>
		    </copy>		
		    <echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>
	    
	    
	    
	    <target name="configure-caxchange-not-to-invoke-c3d"   depends="replace,init"  description="Configures caxchange not to invoke C3D target services for REGISTER_SUBJECT and STUDY_CREATION messages." >
		    
		    <condition property="ifNotInvoke">
			    <and>
				    <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
			    </and>
		    </condition>
		    <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
		    <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/apache-servicemix-3.1.2/conf/caXchangeConf_original_before_testing."/>
		    <echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
		    <input   message="Do you want to continue?"
			     validargs="y,n"
			     addproperty="ifyesorginotinvoke"/>
		    <condition property="ifnoorginotinvoke">
			    <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
		    </condition>
		    <fail if="ifnoorginotinvoke">Please use this target to configure caXchange not to invoke C3D target services for REGISTER_SUBJECT and STUDY_CREATION messages. </fail>
		    <antcall target="call-stop-servicemix-in-unix"/>
		    <antcall target="call-stop-servicemix-in-win"/>
		    <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
			    <fileset dir="${servicemix.home}/conf/caXchangeConf"/>
		    </copy>
		    <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
			    <fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_No_C3D"/>
		    </copy>		
		    <echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>
	    
	    
	    
	    <target name="configure-caxchange-to-invoke-only-psc"   depends="replace,init"  description="Configures caxchange to invoke only PSC target services for REGISTER_SUBJECT and STUDY_CREATION messages." >
		    
		    <condition property="ifNotInvoke">
			    <and>
				    <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
			    </and>
		    </condition>
		    <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
		    <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/conf/caXchangeConf_original_before_testing."/>
		    <echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
		    <input   message="Do you want to continue?"
			     validargs="y,n"
			     addproperty="ifyesorginotinvoke"/>
		    <condition property="ifnoorginotinvoke">
			    <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
		    </condition>
		    <fail if="ifnoorginotinvoke">Please use this target to configure caXchange to test integration only with PSC for STUDY_CREATION and REGISTER_SUBJECT messages</fail>
		    <antcall target="call-stop-servicemix-in-unix"/>
		    <antcall target="call-stop-servicemix-in-win"/>
		    <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
			    <fileset dir="${servicemix.home}/conf/caXchangeConf"/>
		    </copy>
		    <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
			    <fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_PSC"/>
		    </copy>		
		    <echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>
	    
	    
	    <target name="configure-caxchange-to-invoke-only-caaers"   depends="replace,init"  description="Configures caxchange to invoke only caAERS target services for REGISTER_SUBJECT and STUDY_CREATION messages." >
		    
		    <condition property="ifNotInvoke">
			    <and>
				    <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
			    </and>
		    </condition>
		    <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
		    <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/conf/caXchangeConf_original_before_testing."/>
		    <echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
		    <input   message="Do you want to continue?"
			     validargs="y,n"
			     addproperty="ifyesorginotinvoke"/>
		    <condition property="ifnoorginotinvoke">
			    <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
		    </condition>
		    <fail if="ifnoorginotinvoke">Please use this target to configure caXchange to test integration only with caAERS for REGISTER_SUBJECT and STUDY_CREATION messages</fail>
		    <antcall target="call-stop-servicemix-in-unix"/>
		    <antcall target="call-stop-servicemix-in-win"/>
		    <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
			    <fileset dir="${servicemix.home}/conf/caXchangeConf"/>
		    </copy>
		    <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
			    <fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_caAERS"/>
		    </copy>		
		    <echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>
	    
	    
	    
	    
	
	<target name="restore-from-backup" depends="init,replace" description="Restores the caxchange configuration form backup">

		<echo message="As part of this servicemix will be stopped and the current caXchange routing configuration will be overwritten."/>
	                <input   message="Do you want to continue?"
	                validargs="y,n"
	                addproperty="ifyesbackup"/>
	                <condition property="ifnotbackup">
	                <equals arg1="n" arg2="${ifyesbackup}"/>
	                </condition>
	                <fail if="ifnotbackup">To restore caxchange configuration please run this target again</fail>
		<condition property="ifNoBackup">
			    		        <not>
			    		            <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>
			    		            
			    		        </not>
		</condition>
		<fail if="ifNoBackup">There is no backup at ${servicemix.home}/conf/caXchangeConf_original_before_testing"</fail>
		<antcall target="call-stop-servicemix-in-unix"/>
					<antcall target="call-stop-servicemix-in-win"/>
		<move todir="${servicemix.home}/conf/caXchangeConf" failonerror="false">
			<fileset dir="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>
		</move>
		 <echo message="Please start servicemix for configuration changes to take effect."/>
	</target>
	
	    <target name="configure-caxchange-to-invoke-only-C3D"   depends="replace,init"  description="Configures caxchange to invoke only C3D target services for REGISTER_SUBJECT messages." >
		    
		    <condition property="ifNotInvoke">
			    <and>
				    <available file="${servicemix.home}/conf/caXchangeConf_original_before_testing"/>    
			    </and>
		    </condition>
		    <fail if="ifNotInvoke">This target backs up current configuration to ${servicemix.home}/conf/caXchangeConf_original_before_testing. This backup folder already exists, please delete to proceed.</fail>
		    <echo message="Backup of your current routing configuration will be located in ${servicemix.home}/conf/caXchangeConf_original_before_testing."/>
		    <echo message="As part of this task servicemix will be stopped, current routing configuration backed up, and routing configuration updated."/>
		    <input   message="Do you want to continue?"
			     validargs="y,n"
			     addproperty="ifyesorginotinvoke"/>
		    <condition property="ifnoorginotinvoke">
			    <equals arg1="n" arg2="${ifyesorginotinvoke}"/>
		    </condition>
		    <fail if="ifnoorginotinvoke">Please use this target to configure caXchange to test integration only with C3D for REGISTER_SUBJECT messages </fail>
		    <antcall target="call-stop-servicemix-in-unix"/>
		    <antcall target="call-stop-servicemix-in-win"/>
		    <copy todir="${servicemix.home}/conf/caXchangeConf_original_before_testing" failonerror="false">
			    <fileset dir="${servicemix.home}/conf/caXchangeConf"/>
		    </copy>
		    <copy todir="${servicemix.home}/conf/caXchangeConf" overwrite="true">
			    <fileset dir="${integration_smoke_test_home}/conf/caXchangeConf_C3D"/>
		    </copy>		
		    <echo message="Please start servicemix for configuration changes to take effect."/>
	    </target>	
</project>